/*! noday  */
function status(a){return a.status>=200&&a.status<300?Promise.resolve(a):Promise.reject(new Error(a.statusText))}function json(a){return a.json()}var Collection=Espresso.Collection,Controller=Espresso.Controller,Model=Espresso.Model,List=Espresso.List,fetcher=function(a,b,c){var d=this;fetch(a).then(status).then(json).then(function(a){d[b]=a,a.sort(function(a,b){return a.created_at<b.created_at?1:-1}),d[c].set(d[b])})["catch"](function(a){console.log("parsing failed",a)})},wrongImg=function(a){return a.href.indexOf("travis")>=0||a.href.indexOf("badge")>=0},generateImgs=function(a){if(!a||!a.infos)return"";for(var b="",c=a.infos,d=c.references.length;d--;){var e=c.references[d];e.image&&!wrongImg(e)&&(b+='<img src="'+e.href+'" width="50" class="link">')}return b},generateCodes=function(a){if(!a||!a.infos)return"";for(var b="",c=a.infos,d=c.codes.length;d--;){var e=c.codes[d];b+="<div>"+marked("```javascript\n"+e.code+"```")+'"</div>'}return b},MenuItem=Controller.extend({init:function(){},clickAnchor:function(){},render:function(){return{anchor:{html:this.model.text,href:this.model.href,onclick:this.clickAnchor}}}}),RepoItem=Controller.extend({init:function(){this.modalCtrl=this.include(modalCtrl)},hasNoCode:function(){return!this.model.README||"NOT DEFINED"===this.model.README||this.model.README.infos&&0===this.model.README.infos.codes.length},hasNoLanguage:function(){return!this.model.language||""===this.model.language},clickCode:function(a){if(a&&a.srcElement){var b=generateCodes(this.model.README);this.modalCtrl.emit("modalCode",b)}},clickImg:function(a){if(a&&a.srcElement){var b=a.srcElement.src;this.modalCtrl.emit("modalImg",b)}},render:function(){return{view:{classList:{editing:this.model.editing,completed:this.model.done}},title:{text:this.model.full_name,href:this.model.html_url},date:{text:moment(this.model.created_at).fromNow()},description:{text:this.model.description,href:this.model.html_url,title:this.model.full_name},language:{text:"Language "+this.model.language,classList:{"u-hide":this.hasNoLanguage()}},user:{href:this.model.html_url,title:this.model.owner?this.model.owner.login:""},user_info:{href:this.model.owner?this.model.owner.html_url:"",text:this.model.owner?this.model.owner.login:""},user_avatar:{src:this.model.owner?this.model.owner.avatar_url:""},images:{html:generateImgs(this.model.README),onclick:this.clickImg},codeTxt:{onclick:this.clickCode,classList:{"u-hide":this.hasNoCode()}},watchers:{text:" "+this.model.watchers},stars:{text:" "+this.model.stargazers_count},forks:{text:" "+this.model.forks_count},issues:{text:" "+this.model.open_issues}}}}),Metrics=Controller.extend({init:function(){this.model=new Model({nextInvocation:"",prevInvocation:""}),this.metrics={}},render:function(){return{next:{text:this.model.nextInvocation},prev:{text:this.model.prevInvocation}}}}),metricsCtrl=new Metrics({view:"metrics",name:"metrics"}),ModalCtrl=Controller.extend({init:function(){this.model.content="",this.addListener("modalCode",function(a){this.set({show:!0,content:a}),window.location.hash="#modal"}),this.addListener("modalImg",function(a){this.set({show:!0,content:"<img src="+a+">"}),window.location.hash="#modal"})},show:function(){this.set({showCode:!this.model.showCode})},render:function(){return{view:{classList:{"modal--show":this.model.show}},content:{html:this.model.content}}}}),modalCtrl=new ModalCtrl({view:"modal",name:"modalComponent"}),App=Controller.extend({init:function(){function a(){var a=c.h=location.hash;"#date"===a&&c.sort("created_at"),"#stars"===a?c.sort("stargazers_count"):"#watchers"===a?c.sort("watchers"):"#forks"===a?c.sort("forks_count"):"#issues"===a?c.sort("open_issues"):"#watchers"===a&&c.sort("watchers")}this.items=[],this.menus=[{href:"/",text:"Home"},{href:"#date",text:"Date"},{href:"#stars",text:"Stars"},{href:"#watchers",text:"Watchers"},{href:"#forks",text:"Forks"},{href:"#issues",text:"Issues"}];var b={};this.order=!0;var c=this;window.onhashchange=a,this.repos=new List(RepoItem),this.menusList=new List(MenuItem),this.modal=this.include(modalCtrl),this.metrics=this.include(metricsCtrl),fetcher.apply(this,["/repositories","items","repos"]),fetch("/metrics").then(status).then(json).then(function(a){b=a,c.metrics.model.set(b)})["catch"](function(a){console.log("parsing failed",a)}),io&&(this.socket=io.connect(),this.socket.on("connect",function(){}),this.socket.on("repos",function(a){a.sort(function(a,b){return a.created_at<b.created_at?1:-1}),c.items=a,c.repos.set(a)}))},sort:function(a){this.items.sort(function(b,c){return b[a]<c[a]?1:-1}),this.order=!this.order,this.repos.set(this.items)},render:function(){return{menus:this.menusList.set(this.menus),repos:this.repos.set(this.todos),modal:this.modal,metrics:this.metrics}}});window.app=new App({view:document.getElementById("repoapp")});